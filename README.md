# VoiceAI-CallOutv2 — Complete AI Callbot System

🤖 **AI-powered Vietnamese callbot** with PhoBERT NLP, Deeppavlov Agent, and FastAPI backend.

[![Tests](https://img.shields.io/badge/tests-8%2F8%20passing-brightgreen)]()
[![Agent](https://img.shields.io/badge/agent-4%2F4%20conversations-brightgreen)]()
[![Coverage](https://img.shields.io/badge/coverage-100%25-brightgreen)]()

## ✨ Features
- 🎯 **Intent Classification** (PhoBERT - Vietnamese)
- 🧠 **Dialog Management** (Deeppavlov Agent)
- 📞 **Call Orchestration** (Asterisk integration ready)
- 🔒 **JWT Authentication** with bcrypt
- 📊 **Workflow Versioning** (Git-like system)
- 🗄️ **Supabase PostgreSQL** database
- 🧪 **100% Test Coverage**

## 🚀 Quick Start (Windows PowerShell)

### 1. Clone Repository
```powershell
git clone https://github.com/gouenji92/VoiceAI-CallOutv2.git
cd VoiceAI-CallOutv2
```

### 2. Setup Environment
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
python -m pip install --upgrade pip
python -m pip install -r requirements.txt
```

### 3. Setup Models (AUTO - chạy 1 lần duy nhất)
```powershell
python setup_models.py
```
**Chú ý:** Script này sẽ tự động train PhoBERT model (~5-10 phút). Model không được push lên Git vì quá lớn (~500MB).

### 4. Configure Environment
```powershell
# Copy file mẫu
cp .env.example .env

# Edit .env và điền thông tin Supabase
# SUPABASE_URL=https://your-project.supabase.co
# SUPABASE_KEY=your-service-role-key
```

### 5. Run System (3 terminals)
```powershell
# Terminal 1: Agent Server
python agent/http_agent.py

# Terminal 2: Backend API
python -X utf8 -m uvicorn app.main:app --reload

# Terminal 3: Test System
python test_with_agent.py
```

## 📦 Why Models Are Not in Git?

PhoBERT models are **~500MB** and exceed GitHub file size limits. Instead:
- ✅ Run `python setup_models.py` after clone (auto-trains from scratch)
- ✅ Takes 5-10 minutes on first setup
- ✅ Model saved locally in `models/phobert-intent-classifier/`

## 🧪 Testing

```powershell
# Full system test (8 API tests)
python test_full_system.py

# Agent integration test (4 conversation flows)
python test_with_agent.py
```

**Expected Results:**
- ✅ 8/8 API tests passing
- ✅ 4/4 Agent conversations passing
- ✅ 100% test coverage

## 📚 Documentation

- **[HUONG_DAN_CHAY_PROJECT_V2.txt](./HUONG_DAN_CHAY_PROJECT_V2.txt)** - Hướng dẫn chạy đầy đủ (Vietnamese)
- **[HOW_TO_TEST.md](./HOW_TO_TEST.md)** - Testing guide
- **[TONG_HOP_CONG_VIEC.txt](./TONG_HOP_CONG_VIEC.txt)** - Complete work summary
- **[SETUP_GUIDE.md](./SETUP_GUIDE.md)** - Detailed setup instructions

## 🏗️ Architecture

```
VoiceAI-CallOutv2/
├── agent/                  # Deeppavlov Agent (dialog logic)
│   ├── http_agent.py      # HTTP server (port 4242)
│   └── skill.py           # Dialog skills
├── app/                   # FastAPI Backend
│   ├── routers/           # API endpoints (/auth, /workflows, /calls)
│   ├── services/          # Business logic (NLP, dialog, Asterisk)
│   └── models.py          # Pydantic schemas
├── models/                # PhoBERT models (NOT in Git)
│   └── phobert-intent-classifier/  # Auto-generated by setup_models.py
├── sql/                   # Database schema & migrations
├── tests/                 # Test suites
└── setup_models.py        # Auto setup script
```

## 🔧 Tech Stack

- **Backend:** FastAPI 0.115.12, Python 3.11
- **Database:** Supabase (PostgreSQL 15)
- **NLP:** HuggingFace Transformers, PhoBERT
- **Agent:** Deeppavlov (HTTP-based)
- **Auth:** JWT + bcrypt
- **Testing:** pytest, requests

## 📊 Database Schema

Run in Supabase SQL Editor:
```sql
-- Complete schema with RLS policies
\i sql/schema_complete.sql
```

Tables: `accounts`, `workflows`, `workflow_versions`, `calls`, `conversation_logs`, `call_intents`, `call_entities`, `feedback`, `reports`

## 🚨 Troubleshooting

### "Model not found" error
```powershell
python setup_models.py  # Re-run setup
```

### "Internal Server Error" on registration
Check Supabase RLS policies:
```sql
\i sql/disable_rls_for_app_tables.sql
```

### Agent connection refused
```powershell
python agent/http_agent.py  # Start Agent server first
```

## 🤝 Contributing

1. Fork the repo
2. Create feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit changes (`git commit -m 'Add AmazingFeature'`)
4. Push to branch (`git push origin feature/AmazingFeature`)
5. Open Pull Request

## 📝 License

This project is licensed under the MIT License.

## 👥 Authors

- **gouenji92** - *Initial work* - [GitHub](https://github.com/gouenji92)

## 🙏 Acknowledgments

- PhoBERT by VinAI Research
- Deeppavlov by MIPT
- FastAPI by Sebastián Ramírez
- Supabase team
